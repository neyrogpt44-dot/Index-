<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SGSHOP138 | Core Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --fire: #ff0000; --bg: #000; --border: #1a1a1a; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; }
        
        .catalog-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 1px; background: var(--border); border: 1px solid var(--border); 
        }

        /* Твоя карточка из GitHub */
        .product-card { background: #000; padding: 20px; transition: 0.3s; cursor: pointer; }
        .product-card:hover { background: #050505; }
        .product-card__img { width: 100%; aspect-ratio: 1/1; object-fit: contain; }
        .product-card__brand { color: var(--fire); font-size: 10px; font-weight: 900; text-transform: uppercase; }
        .product-card__name { font-size: 14px; margin: 5px 0 15px; height: 40px; overflow: hidden; }

        /* МОДАЛКА КАРТОЧКИ ТОВАРА */
        .modal-product { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.98); 
            display: none; z-index: 2000; padding: 40px; overflow-y: auto;
        }
        .modal-product.active { display: block; }
        .modal-content { max-width: 1200px; margin: 0 auto; display: flex; gap: 60px; }

        .product-gallery { flex: 1; }
        .product-info { flex: 1; }

        /* Селектор цветов */
        .color-selector { display: flex; gap: 10px; margin: 20px 0; }
        .color-option { 
            width: 70px; height: 70px; border: 1px solid #222; 
            cursor: pointer; padding: 5px; background: #0a0a0a;
        }
        .color-option.active { border-color: var(--fire); }
        .color-option img { width: 100%; height: 100%; object-fit: cover; }

        /* Селектор размеров */
        .size-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin: 20px 0; }
        .size-item { 
            border: 1px solid #333; padding: 12px; text-align: center; 
            cursor: pointer; font-size: 13px; font-weight: 700;
        }
        .size-item:hover { border-color: #fff; }
        .size-item.active { background: #fff; color: #000; border-color: #fff; }

        .btn-buy { 
            background: var(--fire); color: #fff; border: none; 
            width: 100%; padding: 20px; font-weight: 900; font-size: 16px; 
            margin-top: 30px; cursor: pointer;
        }
        .close-modal { position: absolute; right: 40px; top: 40px; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="catalog-grid" id="catalog-holder"></div>
</div>

<div class="modal-product" id="product-modal">
    <div class="close-modal" onclick="closeProduct()">✕</div>
    <div class="modal-content" id="modal-data"></div>
</div>

<script>
    let productsData = {}; // Здесь будем хранить сгруппированные данные

    async function loadEngine() {
        const response = await fetch('/api/get'); // Путь к твоему XML
        const text = await response.text();
        const xml = new DOMParser().parseFromString(text, "text/xml");
        const offers = Array.from(xml.querySelectorAll("offer"));

        offers.forEach(el => {
            const rawName = el.querySelector("name").textContent;
            // Группируем по названию, отсекая цвет в скобках
            const baseName = rawName.split('(')[0].trim();
            const img = el.querySelector("picture").textContent;
            const size = el.querySelector('param[name="Размер"]')?.textContent || "EU";

            if (!productsData[baseName]) {
                productsData[baseName] = {
                    name: baseName,
                    brand: el.querySelector("vendor")?.textContent || "Бренд",
                    desc: el.querySelector("description")?.textContent || "Описание скоро появится...",
                    colors: {} // Ключ — ссылка на картинку
                };
            }

            if (!productsData[baseName].colors[img]) {
                productsData[baseName].colors[img] = {
                    img: img,
                    price: el.querySelector("price").textContent,
                    sizes: []
                };
            }
            productsData[baseName].colors[img].sizes.push(size);
        });

        renderCatalog();
    }

    function renderCatalog() {
        const holder = document.getElementById('catalog-holder');
        holder.innerHTML = Object.values(productsData).map(p => `
            <div class="product-card" onclick="openProduct('${p.name.replace(/'/g, "\\'")}')">
                <img src="${Object.values(p.colors)[0].img}" class="product-card__img">
                <div class="product-card__brand">${p.brand}</div>
                <div class="product-card__name">${p.name}</div>
                <div style="font-weight:900;">${Object.values(p.colors)[0].price} ₽</div>
            </div>
        `).join('');
    }

    function openProduct(name) {
        const p = productsData[name];
        const firstImg = Object.keys(p.colors)[0];
        renderModal(p, firstImg);
        document.getElementById('product-modal').classList.add('active');
    }

    function renderModal(p, selectedImg) {
        const variant = p.colors[selectedImg];
        const holder = document.getElementById('modal-data');
        
        holder.innerHTML = `
            <div class="product-gallery">
                <img src="${selectedImg}" style="width:100%; sticky; top:0;">
            </div>
            <div class="product-info">
                <div class="product-card__brand">${p.brand}</div>
                <h1 style="font-size:32px; margin: 10px 0 30px;">${p.name}</h1>
                <div style="font-size:36px; font-weight:900; margin-bottom:40px;">${variant.price} ₽</div>
                
                <p style="font-size:12px; font-weight:800; color:#555;">ДОСТУПНЫЕ ЦВЕТА</p>
                <div class="color-selector">
                    ${Object.keys(p.colors).map(img => `
                        <div class="color-option ${img === selectedImg ? 'active' : ''}" 
                             onclick="renderModal(productsData['${p.name.replace(/'/g, "\\'")}'], '${img}')">
                            <img src="${img}">
                        </div>
                    `).join('')}
                </div>

                <p style="font-size:12px; font-weight:800; color:#555; margin-top:40px;">ВЫБЕРИТЕ РАЗМЕР (EU)</p>
                <div class="size-selector">
                    ${variant.sizes.sort().map(s => `<div class="size-item" onclick="selectSize(this)">${s}</div>`).join('')}
                </div>

                <div style="margin-top:40px; color:#888; line-height:1.6; font-size:14px;">
                    ${p.desc}
                </div>

                <button class="btn-buy">ДОБАВИТЬ В КОРЗИНУ</button>
            </div>
        `;
    }

    function selectSize(el) {
        document.querySelectorAll('.size-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }

    function closeProduct() {
        document.getElementById('product-modal').classList.remove('active');
    }

    loadEngine();
</script>
</body>
</html>
